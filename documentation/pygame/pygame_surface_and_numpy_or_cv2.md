[![StackOverflow](https://stackexchange.com/users/flair/7322082.png)](https://stackoverflow.com/users/5577765/rabbid76?tab=profile) &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [![reply.it](../../resource/logo/Repl_it_logo_80.png) reply.it](https://repl.it/repls/folder/PyGame%20Examples)

"The first principle is that you must not fool yourself and you are the easiest person to fool."  
Richard P. Feynman

---

# Surface and NumPy or cv2

## Check pixel

Related Stack Overflow questions:

- [is there a faster way of checking if list[i] of pygame surface has alpha 0](https://stackoverflow.com/questions/68138764/is-there-a-faster-way-of-checking-if-listi-of-pygame-surface-has-alpha-0/68139807#68139807)

## Load OpenCV (cv2) image

Related Stack Overflow questions:

- [How do I convert an OpenCV (cv2) image (BGR and BGRA) to a pygame.Surface object](https://stackoverflow.com/questions/64183409/how-do-i-convert-an-opencv-cv2-image-bgr-and-bgra-to-a-pygame-surface-object/64183410#64183410)  
  ![How do I convert an OpenCV (cv2) image (BGR and BGRA) to a pygame.Surface object](https://i.stack.imgur.com/J5itT.png)
- [Temporary save Image in pygame](https://stackoverflow.com/questions/64410240/temporary-save-image-in-pygame/64410622#64410622)
- [Pygame, create grayscale from 2d numpy array](https://stackoverflow.com/questions/40755989/pygame-create-grayscale-from-2d-numpy-array)

### How do I convert an OpenCV (cv2) image (BGR and BGRA) to a pygame.Surface object

The `shape` attribute of a [`numpy.array`](https://numpy.org/doc/stable/reference/generated/numpy.array.html) is the number of elements in each dimension. The first element is the height, the second the width and the third the number of channels.  
A [`pygame.Surface`](https://www.pygame.org/docs/ref/surface.html) can be generated by [`pygame.image.frombuffer`](https://www.pygame.org/docs/ref/image.html#pygame.image.frombuffer). The 1st argument can be a `numpy.array` and the 2nd argument is the format (`RGB` or `RGBA`).

Get the size (_widht_, _height_) for the `pygame.Surface` object by slicing:

```py
size = cv2Image.shape[1::-1]
```

Determine the target format for the `pygame.Surface` object, depending on the third channel:

```py
format = 'RGBA' if cv2Image.shape[2] == 4 else 'RGB'
```

Since the source format is _BGR_ or _BGRA_, but the target format is _RGB_ or _RGBA_, the red and blue channels have to be swapped:

```py
cv2Image[:, :, [0, 2]] = cv2Image[:, :, [2, 0]]
```

In the case of a grayscale image, the shape of the array must be changed using [`numpy.reshape`](https://numpy.org/doc/stable/reference/generated/numpy.reshape.html) and the gray channel must be expanded to a red-green and blue color channel using [`numpy.repeat`](https://numpy.org/doc/stable/reference/generated/numpy.repeat.html):

```py
cv2Image = np.repeat(cv2Image.reshape(size[1], size[0], 1), 3, axis = 2)
```

With his data the `pygame.Surface` object can be generated by `pygame.image.frombuffer`:

```py
surface = pygame.image.frombuffer(cv2Image.flatten(), size, format)
```

To ensure that the image has the same pixel format as the display _Surface_ and for optimal performance, the _Surface_ should be converted with either [`convert`](https://www.pygame.org/docs/ref/surface.html#pygame.Surface.convert) or [`convert_alpha`](https://www.pygame.org/docs/ref/surface.html#pygame.Surface.convert_alpha):

```py
surface = surface.convert_alpha() if format == 'RGBA' else surface.convert()
```

Complete function `cv2ImageToSurface`:

```py
def cv2ImageToSurface(cv2Image):
    if cv2Image.dtype.name == 'uint16':
        cv2Image = (cv2Image / 256).astype('uint8')
    size = cv2Image.shape[1::-1]
    if len(cv2Image.shape) == 2:
        cv2Image = np.repeat(cv2Image.reshape(size[1], size[0], 1), 3, axis = 2)
        format = 'RGB'
    else:
        format = 'RGBA' if cv2Image.shape[2] == 4 else 'RGB'
        cv2Image[:, :, [0, 2]] = cv2Image[:, :, [2, 0]]
    surface = pygame.image.frombuffer(cv2Image.flatten(), size, format)
    return surface.convert_alpha() if format == 'RGBA' else surface.convert()
```

:scroll: **[Minimal example - Load cv2 image to PyGame _Surface_](../../examples/minimal_examples/pygame_minimal_surface_load_from_cv2.py)**

![Load cv2 image to PyGame _Surface_](https://i.stack.imgur.com/uJ19U.png)

## Capture screen and convert Surface to cv2

Related Stack Overflow questions:

- [Read pygame window with open cv](https://stackoverflow.com/questions/68841168/read-pygame-window-with-open-cv/68842883#68842883)
- [Pygame surface to opencv image object (not file saving)](https://stackoverflow.com/questions/72756330/pygame-surface-to-opencv-image-object-not-file-saving/72756521#72756521)  
  ![Pygame surface to opencv image object (not file saving](https://i.stack.imgur.com/NItjk.png)

:scroll: **[Minimal example - cv2 image From PyGame _Surface_](../../examples/minimal_examples/pygame_minimal_surface_to_cv2.py)**


Actually, a _cv2_ image is just a three-dimensional _numpy_ array. the 1st dimension is the height, the 2nd the width and the 3rd the number of channels in the order blue, green, red.  
Use [`pygame.surfarray.pixels3d`](https://www.pygame.org/docs/ref/surfarray.html#pygame.surfarray.pixels3d) to reference pixels into a 3d array:

```py
img_array = numpy.array(pygame.surfarray.pixels3d(selected_area))
```

Unfortunately, the pixels are stored in row mayor order. The color channels are in the order red, green, blue. So you need to reformat this array. [`transpose`](https://numpy.org/doc/stable/reference/generated/numpy.transpose.html) the array:

```py
image_object = numpy.transpose(img_array, (1, 0, 2))
```

Finally swap the red and blue color channel with either

```py
image_object[:, :, [0, 2]] = image_object[:, :, [2, 0]]
```

or

```py
image_object = cv2.cvtColor(image_object, cv2.COLOR_RGB2BGR)
```

Convert function:

```py
def pygameSurfaceToCv2Image(mysurface, x, y, w, h):
    selected_area =  mysurface.subsurface((x, y, w, h))
    img_array = numpy.array(pygame.surfarray.pixels3d(selected_area))
    image_object = numpy.transpose(img_array, (1, 0, 2))
    #image_object[:, :, [0, 2]] = image_object[:, :, [2, 0]]
    image_object = cv2.cvtColor(image_object, cv2.COLOR_RGB2BGR)
    return image_object
```


### Load frames from NumPy array

Related Stack Overflow questions:

- [Pygame and Numpy Animations](https://stackoverflow.com/questions/54415196/pygame-and-numpy-animations/54948473#54948473)

Load multiple frames (`data`) of 8-bit BGRA images of shape _(y, x, 4, k)_ to a list of [`pygame.Surface`](https://www.pygame.org/docs/ref/surface.html) objects:

```py
surf_list = [pygame.image.frombuffer(d[:,:,[2, 1, 0, 3]].flatten(), (data.shape[1::-1]), 'RGBA') for d in data.transpose(3, 0, 1, 2)]
```

respectively

```py
surf_list = []
for d in data.transpose(3, 0, 1, 2):
    bytes = d[:,:,[2, 1, 0, 3]].flatten()
    size = data.shape[1::-1]
    format = 'RGBA'
    surface = pygame.image.frombuffer(bytes, size, format)
    surf_list.append(surface)
```

Explanation:

Use [`numpy.traspose`](https://numpy.org/doc/stable/reference/generated/numpy.transpose.html) to bring the 3rd (frame) axis moving axis 2 to the front (see [Iterating over arbitrary dimension of numpy.array](https://stackoverflow.com/questions/1589706/iterating-over-arbitrary-dimension-of-numpy-array)) and iterate through the frames:

```py
for d in data.transpose(3, 0, 1, 2):
```

Create a [`pygame.Surface`](https://www.pygame.org/docs/ref/surface.html) from each frame by [`pygame.image.frombuffer()`](https://www.pygame.org/docs/ref/image.html#pygame.image.frombuffer):

```py
surface = pygame.image.frombuffer(bytes, size, format)
```

[`pygame.image.frombuffer()`](https://www.pygame.org/docs/ref/image.html#pygame.image.frombuffer) has 3 arguments, _bytes_, _size_, _format_. _bytes_ is the 1 dimensional byte array of pixel data. [`numpy.ndarray.flatten`](https://numpy.org/doc/stable/reference/generated/numpy.ndarray.flatten.html) return a copy of the array collapsed into one dimension. Most likely the order of the color channels is _BGRA_ rather than _RGBA_. Hence you have to swap the red and blue color channel (`d[:,:,[2, 1, 0, 3]]`). You can skip this if the order of the color channels is _RGBA_:

```py
bytes = d[:,:,[2, 1, 0, 3]].flatten() # for BGRA
```

```py
bytes = d.flatten() # for RGBA
```

_size_ is a tuple with 2 elements (_x_, _y_) and specifies the size of the image. The size can be get form [`numpy.ndarray.shape`](https://numpy.org/doc/stable/reference/generated/numpy.ndarray.shape.html):

```py
size = data.shape[1::-1]
```

or

```py
size = (data.shape[1], data.shape[0])
```

_format_ specifies the image format and has to be `'RGBA'` (`'BGRA'` doesn't exist):

```py
format = 'RGBA'
```

:scroll: **[Minimal example - Load frames from NumPy array](../../examples/minimal_examples/pygame_minimal_surface_load_frames_numpy.py)**

![Pygame and Numpy Animations](https://i.stack.imgur.com/PKT8H.gif)

### Load animated GIF

- [Animated sprite from few images](https://stackoverflow.com/questions/14044147/animated-sprite-from-few-images/64668964#64668964)  
  ![Animated sprite from few images](https://i.stack.imgur.com/SzKwL.gif)

- [How can I load an animated GIF and get all of the individual frames in PyGame?](https://stackoverflow.com/questions/29571399/how-can-i-load-an-animated-gif-and-get-all-of-the-individual-frames-in-pygame)
- [How do I make a sprite as a gif in pygame?](https://stackoverflow.com/questions/64179680/how-do-i-make-a-sprite-as-a-gif-in-pygame/64182074#64182074)

Or use [OpenCV](https://opencv.org/)/[_opencv-python_](https://pypi.org/project/opencv-python/) library and [`VideoCapture`](https://docs.opencv.org/master/d8/dfe/classcv_1_1VideoCapture.html)

Write a function, that can convert a cv2 [`pygame.image`](https://www.pygame.org/docs/ref/image.html) image to a [`pygame.Surface`](https://www.pygame.org/docs/ref/surface.html) a nd use the library to load a GIF frame by frame:  
(see also [Read GIF files in Python](https://www.facebook.com/MLandDS/posts/read-gif-files-in-pythonimport-cv2from-pil-import-imagegif-cv2videocapturemy_fil/2397352997206918/) and [How do I convert an OpenCV (cv2) image (BGR and BGRA) to a pygame.Surface object](https://stackoverflow.com/questions/64183409/how-do-i-convert-an-opencv-cv2-image-bgr-and-bgra-to-a-pygame-surface-object/64183410#64183410))  

```py
import cv2
```

```py
def cv2ImageToSurface(cv2Image):
    size = cv2Image.shape[1::-1]
    format = 'RGBA' if cv2Image.shape[2] == 4 else 'RGB'
    cv2Image[:, :, [0, 2]] = cv2Image[:, :, [2, 0]]
    surface = pygame.image.frombuffer(cv2Image.tostring(), size, format)
    return surface.convert_alpha() if format == 'RGBA' else surface.convert()

def loadGIF(filename):
    gif = cv2.VideoCapture(filename)
    frames = []
    while True:
        ret, cv2Image = gif.read()
        if not ret:
            break
        pygameImage = cv2ImageToSurface(cv2Image)
        frames.append(pygameImage)
    return frames
```

:scroll: **[Minimal example - Load animated GIF PyGame _Surface_ list using cv2](../../examples/minimal_examples/pygame_minimal_surface_load_frames_gif_cv2.py)**

![How can I load an animated GIF and get all of the individual frames in PyGame?](https://i.stack.imgur.com/geYjP.gif)